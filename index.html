<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ä½œæ¥­å·¥ç¨‹è¡¨ç¢ºèª</title>
<style>
    body { font-family: sans-serif; margin: 10px; background-color: #f0f0f0; }
    h1 { color: #333; text-align: center; font-size: 1.2rem; }
    #reloadButton {
        display: block; margin: 0 auto 20px; padding: 10px 20px;
        background-color: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;
        font-weight: bold;
    }
    .container { overflow-x: auto; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    table { border-collapse: collapse; width: 100%; table-layout: fixed; min-width: 1400px; }
    th, td { border: 1px solid #ddd; padding: 4px; text-align: center; font-size: 9pt; height: 35px; }
    
    /* å·¦ç«¯ï¼ˆæ‹…å½“è€…åï¼‰ã®å›ºå®š */
    .name-column { background-color: #e8e8e8; font-weight: bold; width: 100px; position: sticky; left: 0; z-index: 5; border-right: 2px solid #ccc; }
    /* æ™‚é–“ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .time-header { background-color: #444; color: white; width: 40px; font-size: 8pt; }
    /* ãƒãƒ¼ã®ä¸­ã®ãƒ†ã‚­ã‚¹ãƒˆ */
    .bar-text { font-size: 8pt; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; pointer-events: none; }
</style>
</head>
<body>
    <h1 id="mainTitle">æœ¬æ—¥ã®ä½œæ¥­å·¥ç¨‹è¡¨</h1>
    <button id="reloadButton">ğŸ”„ æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã«æ›´æ–°</button>
    <div class="container" id="ganttContainer">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>

<script>
    // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ã€Œå…¥åŠ›ã€ã‚·ãƒ¼ãƒˆã‚’CSVå…¬é–‹ã—ãŸURL
    const PUBLIC_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTpvVF_Vr1KaDNLsa03dZZrD_iMBLEw_l_4bJP3E_e223SADZYC2B_iOzNr2VCxkRCWKMVbu2iebL1Z/pub?gid=786246587&single=true&output=csv';

    const START_HOUR = 4;
    const END_HOUR = 21;
    const INTERVAL = 30;

    // CSVã®1è¡Œã‚’æ­£ã—ãåˆ†å‰²ã™ã‚‹ãŸã‚ã®é–¢æ•°ï¼ˆå¼•ç”¨ç¬¦å†…ã®ã‚«ãƒ³ãƒã‚’ç„¡è¦–ã™ã‚‹ï¼‰
    function splitCsvLine(line) {
        const result = [];
        let cur = '';
        let inQuote = false;
        for (let char of line) {
            if (char === '"') {
                inQuote = !inQuote;
            } else if (char === ',' && !inQuote) {
                result.push(cur.trim());
                cur = '';
            } else {
                cur += char;
            }
        }
        result.push(cur.trim());
        return result;
    }

    async function updateSchedule() {
        try {
            const res = await fetch(PUBLIC_CSV_URL);
            const csvText = await res.text();
            const rawRows = csvText.trim().split('\n');
            
            // 2è¡Œç›®ä»¥é™ã‚’è§£æ
            const tasks = rawRows.slice(1).map(line => {
                const r = splitCsvLine(line);
                return {
                    job: r[1],
                    staff: r[2],
                    start: r[3],
                    end: r[4],
                    color: r[6] || '#cccccc'
                };
            }).filter(t => t.job && t.staff && t.start && t.end);

            renderChart(tasks);
        } catch (e) {
            document.getElementById('ganttContainer').innerHTML = 'ã‚¨ãƒ©ãƒ¼: ' + e.message;
        }
    }

    function renderChart(tasks) {
        let staffMap = {};
        tasks.forEach(t => {
            // ã‚«ãƒ³ãƒã‚„èª­ç‚¹ã§åŒºåˆ‡ã‚‰ã‚ŒãŸåå‰ã‚’ãƒãƒ©ã™
            let names = t.staff.replace(/"/g, '').split(/[,ã€]/);
            names.forEach(n => {
                let name = n.trim();
                if (!name) return;
                if (!staffMap[name]) staffMap[name] = [];
                staffMap[name].push(t);
            });
        });

        // æ‹…å½“è€…åã‚’ã‚ã„ã†ãˆãŠé †ã«ä¸¦ã³æ›¿ãˆ
        const sortedStaff = Object.keys(staffMap).sort();

        let html = '<table><thead><tr><th class="name-column">æ‹…å½“è€…</th>';
        for (let h = START_HOUR; h < END_HOUR; h++) {
            for (let m = 0; m < 60; m += INTERVAL) {
                let timeStr = `${h}:${m === 0 ? '00' : m}`;
                html += `<th class="time-header">${timeStr}</th>`;
            }
        }
        html += '</tr></thead><tbody>';

        sortedStaff.forEach(staff => {
            html += `<tr><td class="name-column">${staff}</td>`;
            
            for (let h = START_HOUR; h < END_HOUR; h++) {
                for (let m = 0; m < 60; m += INTERVAL) {
                    let currentTime = h * 60 + m;
                    
                    let task = staffMap[staff].find(t => {
                        let [sh, sm] = t.start.split(':').map(Number);
                        let [eh, em] = t.end.split(':').map(Number);
                        let sTotal = sh * 60 + sm;
                        let eTotal = eh * 60 + em;
                        return currentTime >= sTotal && currentTime < eTotal;
                    });

                    if (task) {
                        let [sh, sm] = task.start.split(':').map(Number);
                        let isStart = currentTime === (sh * 60 + sm);
                        // ã‚»ãƒ«ã®èƒŒæ™¯è‰²ã‚’é©ç”¨
                        html += `<td style="background-color:${task.color};"><div class="bar-text">${isStart ? task.job : ''}</div></td>`;
                    } else {
                        html += '<td></td>';
                    }
                }
            }
            html += '</tr>';
        });
        html += '</tbody></table>';
        document.getElementById('ganttContainer').innerHTML = html;
    }

    window.onload = updateSchedule;
    document.getElementById('reloadButton').onclick = updateSchedule;
</script>
</body>
</html>
