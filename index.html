<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ä½œæ¥­å·¥ç¨‹è¡¨ç¢ºèª</title>
<style>
    body { font-family: sans-serif; margin: 10px; background-color: #f0f0f0; }
    h1 { color: #333; text-align: center; font-size: 1.2rem; margin-bottom: 10px; }
    .controls { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
    button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
    #reloadButton { background-color: #4CAF50; color: white; }
    #reloadButton:active { background-color: #3e8e41; }
    .view-btn { background-color: #2196F3; color: white; }
    .view-btn.active { background-color: #0d47a1; box-shadow: inset 0 2px 4px rgba(0,0,0,0.3); }
    .container { overflow-x: auto; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    /* åˆ—æ•°ãŒå¢—ãˆã‚‹ãŸã‚ã€min-widthã‚’èª¿æ•´ */
    table { border-collapse: collapse; width: 100%; table-layout: fixed; min-width: 2500px; }
    th, td { border: 1px solid #ddd; padding: 4px; text-align: center; font-size: 9pt; height: 35px; }
    .name-column { background-color: #e8e8e8; font-weight: bold; width: 120px; position: sticky; left: 0; z-index: 5; border-right: 2px solid #ccc; }
    .time-header { background-color: #444; color: white; width: 40px; font-size: 8pt; }
    .bar-text { font-size: 8pt; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; pointer-events: none; }
</style>
</head>
<body>
    <h1 id="mainTitle">ä½œæ¥­å·¥ç¨‹è¡¨</h1>
    
    <div class="controls">
        <button id="reloadButton">ğŸ”„ ãƒ‡ãƒ¼ã‚¿ã‚’æœ€æ–°ã«æ›´æ–°</button>
        <button class="view-btn active" id="staffViewBtn">ğŸ‘¤ æ‹…å½“è€…åŸºæº–</button>
        <button class="view-btn" id="taskViewBtn">ğŸ“‹ æ¥­å‹™åŸºæº–</button>
    </div>

    <div class="container" id="ganttContainer">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>

<script>
    const PUBLIC_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTpvVF_Vr1KaDNLsa03dZZrD_iMBLEw_l_4bJP3E_e223SADZYC2B_iOzNr2VCxkRCWKMVbu2iebL1Z/pub?gid=786246587&single=true&output=csv';

    const START_HOUR = 4;
    const END_HOUR = 21;
    const INTERVAL = 15; // 30ã‹ã‚‰15ã«å¤‰æ›´

    let currentTasks = [];
    let currentMode = 'staff'; 

    function splitCsvLine(line) {
        const result = [];
        let cur = '';
        let inQuote = false;
        for (let char of line) {
            if (char === '"') inQuote = !inQuote;
            else if (char === ',' && !inQuote) { result.push(cur.trim()); cur = ''; }
            else cur += char;
        }
        result.push(cur.trim());
        return result;
    }

    async function updateData() {
        const btn = document.getElementById('reloadButton');
        btn.innerText = 'â³ èª­ã¿è¾¼ã¿ä¸­...';
        try {
            const res = await fetch(PUBLIC_CSV_URL + '&cache=' + new Date().getTime());
            const csvText = await res.text();
            const rawRows = csvText.trim().split('\n');
            
            if (rawRows.length > 1) {
                const firstRowData = splitCsvLine(rawRows[1]);
                const h2Date = firstRowData[7];
                if (h2Date) {
                    document.getElementById('mainTitle').innerText = h2Date + " ã®ä½œæ¥­å·¥ç¨‹è¡¨";
                }
            }

            currentTasks = rawRows.slice(1).map(line => {
                const r = splitCsvLine(line);
                const colors = (r[6] || "").split(',');
                return {
                    job: r[1],
                    staff: (r[2] || "").replace(/"/g, ''),
                    start: r[3],
                    end: r[4],
                    colorMaster: colors[0] || '#cccccc',
                    colorInputF: colors[1] || '#cccccc'
                };
            }).filter(t => t.job && t.start && t.end);

            renderChart();
            btn.innerText = 'ğŸ”„ ãƒ‡ãƒ¼ã‚¿ã‚’æœ€æ–°ã«æ›´æ–°';
        } catch (e) {
            document.getElementById('ganttContainer').innerHTML = 'ã‚¨ãƒ©ãƒ¼: ' + e.message;
            btn.innerText = 'ğŸ”„ ãƒ‡ãƒ¼ã‚¿ã‚’æœ€æ–°ã«æ›´æ–°';
        }
    }

    function renderChart() {
        let displayData = {};
        if (currentMode === 'staff') {
            currentTasks.forEach(t => {
                let names = t.staff.split(/[,ã€]/);
                names.forEach(n => {
                    let name = n.trim();
                    if (!name) return;
                    if (!displayData[name]) displayData[name] = [];
                    displayData[name].push(t);
                });
            });
        } else {
            currentTasks.forEach((t, index) => {
                let key = `${index}_${t.job}`;
                if (!displayData[key]) displayData[key] = [];
                displayData[key].push(t);
            });
        }

        const keys = currentMode === 'staff' ? Object.keys(displayData).sort() : Object.keys(displayData);

        let html = '<table><thead><tr><th class="name-column">' + (currentMode === 'staff' ? 'æ‹…å½“è€…' : 'æ¥­å‹™å') + '</th>';
        for (let h = START_HOUR; h < END_HOUR; h++) {
            for (let m = 0; m < 60; m += INTERVAL) {
                html += `<th class="time-header">${h}:${m === 0 ? '00' : m}</th>`;
            }
        }
        html += '</tr></thead><tbody>';

        keys.forEach(key => {
            let rowLabel = currentMode === 'staff' ? key : key.split('_')[1];
            html += `<tr><td class="name-column">${rowLabel}</td>`;
            for (let h = START_HOUR; h < END_HOUR; h++) {
                for (let m = 0; m < 60; m += INTERVAL) {
                    let currentTime = h * 60 + m;
                    let task = displayData[key].find(t => {
                        let [sh, sm] = (t.start || "0:0").split(':').map(Number);
                        let [eh, em] = (t.end || "0:0").split(':').map(Number);
                        return currentTime >= (sh * 60 + sm) && currentTime < (eh * 60 + em);
                    });

                    if (task) {
                        let [sh, sm] = task.start.split(':').map(Number);
                        let isStart = currentTime === (sh * 60 + sm);
                        let barText = currentMode === 'staff' ? task.job : task.staff;
                        let appliedColor = currentMode === 'staff' ? task.colorInputF : task.colorMaster;
                        html += `<td style="background-color:${appliedColor};"><div class="bar-text">${isStart ? barText : ''}</div></td>`;
                    } else {
                        html += '<td></td>';
                    }
                }
            }
            html += '</tr>';
        });
        html += '</tbody></table>';
        document.getElementById('ganttContainer').innerHTML = html;
    }

    document.getElementById('reloadButton').addEventListener('click', updateData);
    document.getElementById('staffViewBtn').addEventListener('click', () => {
        currentMode = 'staff';
        document.getElementById('staffViewBtn').classList.add('active');
        document.getElementById('taskViewBtn').classList.remove('active');
        renderChart();
    });
    document.getElementById('taskViewBtn').addEventListener('click', () => {
        currentMode = 'task';
        document.getElementById('taskViewBtn').classList.add('active');
        document.getElementById('staffViewBtn').classList.remove('active');
        renderChart();
    });

    window.onload = updateData;
</script>
</body>
</html>
